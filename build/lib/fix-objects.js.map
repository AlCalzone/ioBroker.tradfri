{
  "version": 3,
  "sources": ["../../src/lib/fix-objects.ts"],
  "sourcesContent": ["import { values } from \"alcalzone-shared/objects\";\nimport { instanceObjects as _instanceObjects } from \"../../io-package.json\";\nimport { Global as _ } from \"./global\";\n\nconst instanceObjects = _instanceObjects as ioBroker.Object[];\n\n/**\n * Fixes/updates/deletes existing adapter objects,\n * so they don't have to be deleted manually\n */\nexport async function fixAdapterObjects(): Promise<void> {\n\t// read all objects, we'll filter them in the fixer functions\n\tconst stateObjs = values(await _.$$(`${_.adapter.namespace}.*`, \"state\"));\n\t// const channelObjs = values(await _.$$(`${_.adapter.namespace}.*`, \"channel\"));\n\t// const deviceObjs = values(await _.$$(`${_.adapter.namespace}.*`, \"device\"));\n\n\tawait fixBrightnessRange(stateObjs);\n\tawait fixAuthenticationObjects();\n\tawait fixBrightnessRole(stateObjs);\n}\n\n/**\n * In v0.5.4, the brightness range was changed from 0..254 to 0..100%\n */\nasync function fixBrightnessRange(stateObjs: ioBroker.Object[]) {\n\tconst predicate = /(G|VG|L)\\-\\d+\\.(lightbulb\\.)?brightness$/;\n\tconst fixableObjs = stateObjs.filter((o) => predicate.test(o._id));\n\tfor (const obj of fixableObjs) {\n\t\tconst oldCommon = JSON.stringify(obj.common);\n\t\tconst newCommon = JSON.stringify({\n\t\t\t// @ts-expect-error This is for compatibility reasons only\n\t\t\tname: \"Brightness\",\n\t\t\t...obj.common,\n\t\t\tmin: 0,\n\t\t\tmax: 100,\n\t\t\tunit: \"%\",\n\t\t});\n\t\tif (oldCommon !== newCommon) {\n\t\t\tobj.common = JSON.parse(newCommon);\n\t\t\tawait _.adapter.setForeignObjectAsync(obj._id, obj);\n\t\t}\n\t}\n}\n\n/**\n * In v0.6.0, the authentication procedure was changed to no longer\n * store the security code.\n * From v0.6.0-beta2 to -beta3, the info.identity object was removed in favor of config properties.\n */\nasync function fixAuthenticationObjects() {\n\tconst identityObj = await _.adapter.getObjectAsync(\"info.identity\");\n\tif (identityObj != null) {\n\t\tawait _.adapter.delState(\"info.identity\");\n\t\tawait _.adapter.delObject(\"info.identity\");\n\t}\n}\n\n/**\n * In v1.0.5, the brightness role was changed from \"light.dimmer\" to \"level.dimmer\"\n */\nasync function fixBrightnessRole(stateObjs: ioBroker.Object[]) {\n\tconst predicate = /(G|VG|L)\\-\\d+\\.(lightbulb\\.)?brightness$/;\n\tconst fixableObjs = stateObjs.filter((o) => predicate.test(o._id));\n\tfor (const obj of fixableObjs) {\n\t\tconst oldCommon = JSON.stringify(obj.common);\n\t\tconst newCommon = JSON.stringify({\n\t\t\t...obj.common,\n\t\t\trole: \"level.dimmer\",\n\t\t});\n\t\tif (oldCommon !== newCommon) {\n\t\t\tobj.common = JSON.parse(newCommon);\n\t\t\tawait _.adapter.setForeignObjectAsync(obj._id, obj);\n\t\t}\n\t}\n}\n\n// Workaround f\u00FCr unvollst\u00E4ndige Adapter-Upgrades\nexport async function ensureInstanceObjects(): Promise<void> {\n\tif (instanceObjects == null || instanceObjects.length === 0) return;\n\n\t// wait for all instance objects to be created\n\tconst setObjects = instanceObjects.map((obj) =>\n\t\t_.adapter.setObjectNotExistsAsync(obj._id, obj),\n\t);\n\tawait Promise.all(setObjects);\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAuB;AACvB,wBAAoD;AACpD,oBAA4B;AAE5B,MAAM,kBAAkB;AAMxB,mCAAyD;AAExD,QAAM,YAAY,2BAAO,MAAM,qBAAE,GAAG,GAAG,qBAAE,QAAQ,eAAe;AAIhE,QAAM,mBAAmB;AACzB,QAAM;AACN,QAAM,kBAAkB;AAAA;AAMzB,kCAAkC,WAA8B;AAC/D,QAAM,YAAY;AAClB,QAAM,cAAc,UAAU,OAAO,CAAC,MAAM,UAAU,KAAK,EAAE;AAC7D,aAAW,OAAO,aAAa;AAC9B,UAAM,YAAY,KAAK,UAAU,IAAI;AACrC,UAAM,YAAY,KAAK,UAAU;AAAA,MAEhC,MAAM;AAAA,OACH,IAAI,SAHyB;AAAA,MAIhC,KAAK;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA;AAEP,QAAI,cAAc,WAAW;AAC5B,UAAI,SAAS,KAAK,MAAM;AACxB,YAAM,qBAAE,QAAQ,sBAAsB,IAAI,KAAK;AAAA;AAAA;AAAA;AAUlD,0CAA0C;AACzC,QAAM,cAAc,MAAM,qBAAE,QAAQ,eAAe;AACnD,MAAI,eAAe,MAAM;AACxB,UAAM,qBAAE,QAAQ,SAAS;AACzB,UAAM,qBAAE,QAAQ,UAAU;AAAA;AAAA;AAO5B,iCAAiC,WAA8B;AAC9D,QAAM,YAAY;AAClB,QAAM,cAAc,UAAU,OAAO,CAAC,MAAM,UAAU,KAAK,EAAE;AAC7D,aAAW,OAAO,aAAa;AAC9B,UAAM,YAAY,KAAK,UAAU,IAAI;AACrC,UAAM,YAAY,KAAK,UAAU,iCAC7B,IAAI,SADyB;AAAA,MAEhC,MAAM;AAAA;AAEP,QAAI,cAAc,WAAW;AAC5B,UAAI,SAAS,KAAK,MAAM;AACxB,YAAM,qBAAE,QAAQ,sBAAsB,IAAI,KAAK;AAAA;AAAA;AAAA;AAMlD,uCAA6D;AAC5D,MAAI,mBAAmB,QAAQ,gBAAgB,WAAW;AAAG;AAG7D,QAAM,aAAa,gBAAgB,IAAI,CAAC,QACvC,qBAAE,QAAQ,wBAAwB,IAAI,KAAK;AAE5C,QAAM,QAAQ,IAAI;AAAA;",
  "names": []
}
